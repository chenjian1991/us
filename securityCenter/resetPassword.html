<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta id="i18n_pagename" content="index">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="../static/web/styles/page/intlTelInput.css?t=20180912">
    <link rel="stylesheet" href="../static/web/styles/page/demo.css?t=20180912">
    <link rel="stylesheet" href="../static/web/styles/index.css?t=20180912">
    <link rel="stylesheet" href="../static/web/styles/header_footer.css?t=20180910">
    <link rel="stylesheet" href="../static/web/iconfont/iconfont.css?t=20180912">
    <link rel="stylesheet" href="../static/web/styles/page/securityCenter.css?t=20180912">
    <title class="i18n" name="xgmmChangeTitle">set password</title>
</head>
<body>
<div class="wrapper">
    <div class="big-container">
        <div class="common-header"></div>
        <div class="phone_wrapper container">
            <div class="phone_content content">
                <a class="phone_nav i18n" name="xgmmAccountSecurity" href="./securityCenter.html"></a>
                <a class="i18n" name="xgmmChangePassword" href="javascript:;"></a>
                <div class="phone_title i18n" name="xgmmExplain"></div>
                <div class="phone-msg">
                    <div name="xgmmChangePassword2" class="phone-msg-nav i18n"></div>
                    <div class="trade-title clearfix">
                        <div class="fl txt-center">
                            <p class="trade-step trade-after">1</p>
                            <p class="i18n step-p1" name="xgmmStep1"></p>
                        </div>
                        <div class="fl txt-center ">
                            <p class="trade-step trade-gray">2</p>
                            <p class="i18n step-p2" name="xgmmStep2"></p>
                        </div>
                    </div>
                    <div class="phone-input-group trading-password-grop">
                        <form id="setPassword">
                            <ul class="trading-content-one">
                                <li class="phone-li-item">
                                    <span class="phone-span-item  i18n" name="xgmmLoginPassword"></span><input type="password" name="loginPass" minlength="8" maxlength='20'>
                                </li>
                                <li class="phone-li-item google-li">
                                    <span class="phone-span-item i18n" name="xgmmGoogleCode"></span><input autocomplete="off" type="text" name="googleCode" minlength="6" maxlength='6'>
                                </li>
                                <li class="phone-li-item trading-next-step">
                                    <button type="button" name="xgmmNext"  class="phone-submit i18n" id="tradingNext"></button>
                                    <button style="display: none;" id="language-change" type="button"></button>
                                </li>
                            </ul>
                        </form>
                        <form id="tradingPass">
                            <ul class="trading-content-two">
                                <li class="phone-li-item">
                                    <span  class="phone-span-item i18n" name="xgmmNewPassword"></span><input id="firstPass"   type="password" minlength="8" maxlength='20' name="resetLoginPassword">
                                </li>
                                <li class="phone-li-item">
                                    <span onkeyup="value=value.replace(/[^\d]/g,'')" class="phone-span-item i18n" name="xgmmConfirmPassword"></span><input minlength="8" maxlength='20'  type="password" name="loginPasswordconfirm">
                                </li>
                                <li class="phone-li-item trading-next-step">
                                    <button type="button" class="phone-submit i18n" name="xgmmSubmit"></button>
                                    <button style="display: none;" id="languagetwo-change" type="button"></button>
                                </li>
                            </ul>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        <div class="common-footer"></div>
    </div>
</div>
</body>
<script type="text/javascript" src='../static/web/js/lib/jquery.min.js?t=20180912'></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

<script type="text/javascript" src="../static/web/js/page/plateformUrl.js?t=20180912"></script>
<script type="text/javascript" src="../static/web/js/lib/jquery-validation-1.7.0.js?t=20180912"></script>
<script type="text/javascript" src='../static/web/js/lib/layer.js?t=20180912'></script>
<script type="text/javascript" src='../static/web/js/page/common_validate.js?t=20180912'></script>
<script type="text/javascript" src='../static/web/js/lib/jquery.i18n.properties.js?t=20180912'></script>
<script type="text/javascript" src='../static/web/js/lib/language.js?t=20180912'></script>
<script type="text/javascript" src="../static/web/js/page/header.js?t=20180912"></script>
<script type="text/javascript" src="../static/web/js/page/dealFooter.js?t=20180912"></script>


<script type="text/javascript">
    var phone = localStorage.getItem('phone');
    $(document).ready(function () {
        var ifsetgooglenumber = localStorage.getItem('google');
        if(ifsetgooglenumber=="true"){
            $('.google-li').show();
        }else {
            $('.google-li').hide();
        }
    })


    $('.smsPhone').html("<span class='i18n' name='jymmSMSCode'>SMS code from</span>"+phone+"<span></span>")
    $(document).ready(function(){
        importHeaderFooter()
        labelName()
        navigation('nav9')
        sanCode()

    })

    /*发送验证码*/
    var InterValObj; //timer变量，控制时间
    var count = 60; //间隔函数，1秒执行
    var curCount;//当前剩余秒数
    function sendMessage(){
        var loginPassword = $('input[name="loginPass"]').val().trim().replace(/\s/g,'')
        if(loginPassword==''){
            layer.msg('<div class="i18n" name="Inputpassword"></div>')
            layerInternational()
            return
        }

        curCount = count;
        //设置button效果，开始计时
        $("#btnSendCode").attr("disabled", "true");
        $("#btnSendCode").text(curCount + "s");
        $('#btnSendCode').addClass('gray')
        InterValObj = window.setInterval(SetRemainTime, 1000);
        var data = {
            "codeType":"PHONE",
            "operateType":"SET_TRADE_PASSWORD"
        }
        $.ajax({
            url:api.tradeSend,
            type:'post',
            data:JSON.stringify(data),
            dataType:'json',
            headers: {
                "Content-Type": "application/json;charset=UTF-8",
                "token": Cookies.get('loginToken')
            },
            success:function(data){
                var code = data.code;
                if(code==10021){
                    layer.msg('<div class="i18n" name="Verification"></div>')
                    layerInternational()
                    window.clearInterval(InterValObj);//停止计时器
                }else if(code==10038){
                    layer.msg('<div class="i18n" name="verificationinvalid">验证码发送无效，请重新发送</div>');
                    layerInternational()
                    window.clearInterval(InterValObj);//停止计时器
                }
            },
            error:function(XMLHttpRequest, textStatus, errorThrown){
                if(XMLHttpRequest.status==500){


                }

            }
        })
    }
    //timer处理函数
    function SetRemainTime() {
        if (curCount == 0) {
            window.clearInterval(InterValObj);//停止计时器
            $("#btnSendCode").removeAttr("disabled");//启用按钮
            $('#btnSendCode').removeClass('gray')
            //$("#btnSendCode").html("retry");
            $("#btnSendCode").attr('name','reaginSendtwo');
            layerInternational()
        }
        else {
            curCount--;
            $("#btnSendCode").text(curCount + "s");
        }
    }

              $('#language-change').click(function() {
                  $('#setPassword').valid()
              })
    
    //下一步点击事件
    $('#tradingNext').click(function(){
        if($('#setPassword').valid()){
            var data = {
                "password":$('input[name="loginPass"]').val().trim().replace(/\s/g,''),
                "googleCode":$('input[name="googleCode"]').val().trim().replace(/\s/g,''),

            }
            sendPostRequestByJsonObj(api.resetlogpasswordFirststep,data,function(data,xhr,textStatus){
                if(textStatus.status==200){
                    var code = data.code;
                    var token = data.token;
                    localStorage.setItem('passwordToken',token);
                    if(code == 10007){
                        layer.msg('<div class="i18n" name="passwordNotCorrect"></div>')
                        layerInternational()
                    }else if(code ==10013){
                        layer.msg('<div class="i18n" name="Unauthorized"></div>')
                        layerInternational()
                        Cookies.remove('loginToken',{domain:document.domain.split('.').slice(-2).join('.')});
                        localStorage.removeItem("curPage");
                        window.location.href='../exchange/b11/index.html#/login'
                    }else if(code ==10010){
                        layer.msg('<div class="i18n" name="passwordNotwright"></div>')
                        layerInternational()
                    }else if(code==10025){
                        layer.msg('<div class="i18n" name="googleNotwright"></div>')
                        layerInternational()
                    }else if(code==10023){
                        layer.msg('<div class="i18n" name="paramError"></div>')
                        layerInternational()
                    }else if(code==403){
                        layer.msg('<div class="i18n" name="illegalRequest"></div>')
                        layerInternational()
                    } else{
                        localStorage.setItem('curPage',1)
                        $('.trading-content-one').hide();
                        $('.trading-content-two').show();
                        $('.trade-step').removeClass('trade-after').addClass('trade-before');
                        $('.trade-gray').addClass('trade-highlight');
                    }

                }
            })

        }

    })
    //刷新后仍然停留在本页面；
    var curPage = localStorage.getItem('curPage');
    if(curPage==1){
        $('#setPassword .trading-content-one').hide();
        $('#tradingPass .trading-content-two').show();
        $('.trade-step').removeClass('trade-after').addClass('trade-before');
        $('.trade-gray').addClass('trade-highlight');
    }else if(curPage==0){
        $('#setPassword .trading-content-one').show();
        $('#tradingPass .trading-content-two').hide();
    }

                      $('#languagetwo-change').click(function() {
                          $('#tradingPass').valid()
                      })
    /*submit设置密码*/
    $('#tradingPass .phone-submit').click(function(){
        $('#tradingPass').valid()
        if($('#tradingPass').valid()){
            var data = {
                "password":$('input[name="loginPasswordconfirm"]').val().trim().replace(/\s/g,''),
                "ex55Pin" :localStorage.getItem('loginEx55Pin')
            }
            $.ajax({
                url:api.resetloginPassword,
                type:'post',
                headers: {
                    "Content-Type": "application/json;charset=UTF-8",
                    "token": localStorage.getItem('passwordToken')
                },
                data:JSON.stringify(data),
                dataType:'json',
                success:function(data,xhr,textStatus){
                    //弹窗的国际化实现
                    //layer.msg('<div class="i18n" name="aleryRegister"></div>')
                    //必须写在layer.msg之后，因为只有渲染完成之后才可以获取到class='i18n'
                    //公共的layer国际化方法
                    if(textStatus.status==200){
                        if(data!=undefined){
                            var code = data.code;
                            if(code == 10013){
                                layer.msg('<div class="i18n" name="Unauthorized"></div>');
                                layerInternational()
                                Cookies.remove('loginToken',{domain:document.domain.split('.').slice(-2).join('.')});
                                localStorage.removeItem("curPage");
                                window.location.href='../exchange/b11/index.html#/login'
                                return false;
                            }else if(code ==10010){ //密码格式不对
                                layer.msg('<div class="i18n" name="passwordnotMatch"></div>');
                                layerInternational()
                                 return false;
                            }else if(code==403){
                                layer.msg('<div class="i18n" name="illegalRequest"></div>')
                                layerInternational()
                            }
                        }
                        layer.msg('<div class="i18n" name="resetwordSucess">success</div>',{
                            time:1500,
                            end:function(){
                                Cookies.remove('loginToken',{domain:document.domain.split('.').slice(-2).join('.')});;
                                localStorage.removeItem("curPage");
                                window.location.href = '../exchange/b11/index.html#/login';
                            }
                        })

                        layerInternational()
                    }


                }

            })


        }


    })

</script>
</html>
